<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Nano Banana Pro API Test</title>
    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
        }

        .image-preview {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .preview-box {
            flex: 1;
            border: 1px dashed #ccc;
            padding: 10px;
            text-align: center;
        }

        img {
            max-width: 100%;
            max-height: 200px;
            display: block;
            margin: 0 auto;
        }

        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }

        button:disabled {
            background: #ccc;
        }

        #result {
            margin-top: 20px;
            border: 1px solid #eee;
            padding: 10px;
            min-height: 100px;
        }

        pre {
            background: #f4f4f4;
            padding: 10px;
            overflow-x: auto;
        }
    </style>
</head>

<body>
    <h1>API Test: Gemini Nano Banana Pro</h1>

    <div class="input-group">
        <label>API Key:</label>
        <input type="text" id="apiKey" placeholder="Enter your Google AI Studio API Key">
    </div>

    <div class="image-preview">
        <div class="preview-box">
            <label>Anime Character (Image 1)</label>
            <input type="file" id="img1" accept="image/*">
            <img id="preview1">
        </div>
        <div class="preview-box">
            <label>Background (Image 2)</label>
            <input type="file" id="img2" accept="image/*">
            <img id="preview2">
        </div>
    </div>

    <button id="testBtn" onclick="testApi()">Test Generation</button>

    <div id="result">
        <h3>Result:</h3>
        <div id="status">Ready</div>
        <img id="resultImg">
        <pre id="debugLog"></pre>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        let file1Data = null;
        let file2Data = null;

        // Image preview logic
        const handleFile = (input, previewId, isFirst) => {
            input.addEventListener('change', e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = evt => {
                    $(previewId).src = evt.target.result;
                    // Remove data:image/...;base64, prefix for API
                    const base64 = evt.target.result.split(',')[1];
                    const mimeType = file.type;

                    if (isFirst) file1Data = { inlineData: { data: base64, mimeType } };
                    else file2Data = { inlineData: { data: base64, mimeType } };
                };
                reader.readAsDataURL(file);
            });
        };

        handleFile($('img1'), 'preview1', true);
        handleFile($('img2'), 'preview2', false);

        async function testApi() {
            const apiKey = $('apiKey').value.trim();
            if (!apiKey) return alert('Please enter API Key');
            if (!file1Data || !file2Data) return alert('Please select both images');

            $('testBtn').disabled = true;
            $('status').innerText = 'Generating... (This may take a few seconds)';
            $('debugLog').innerText = '';
            $('resultImg').src = '';

            try {
                // Trying the specific model ID provided by the user
                const modelName = "gemini-3-pro-image-preview";

                const payload = {
                    contents: [{
                        parts: [
                            { text: "Generate an image. Task: Extract the anime character from the first image and composite it seamlessly into the second background image. \n\nRequirements:\n1. Precise segmentation of the character.\n2. Adjust lighting, shadows, and color tone of the character to match the background environment perfectly.\n3. Maintain the character's original design and details.\n4. Output ONLY the final composite image." },
                            file1Data,
                            file2Data
                        ]
                    }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ],
                    // Adding generation config for image generation
                    // Note: The REST API field names might differ slightly from Python SDK.
                    // Trying standard mapping.
                    generationConfig: {
                        // Some experimental models require specific flags or tools config
                        // For now, we try to pass image-like parameters if supported
                    }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                $('debugLog').innerText = JSON.stringify(data, null, 2);

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (!data.candidates || data.candidates.length === 0) {
                    if (data.promptFeedback) {
                        throw new Error("Blocked by safety filters: " + JSON.stringify(data.promptFeedback));
                    }
                    throw new Error("No candidates returned. The model might not support this output type or silently blocked it.");
                }

                const candidate = data.candidates[0];
                if (candidate.finishReason !== "STOP") {
                    console.warn("Finish reason:", candidate.finishReason);
                }

                // Try to find image in parts
                const parts = candidate.content.parts;
                let foundImage = false;
                for (const part of parts) {
                    if (part.inlineData) {
                        $('resultImg').src = `data:${part.inlineData.mimeType};base64,${part.inlineData.data}`;
                        foundImage = true;
                        break;
                    }
                }

                if (!foundImage) {
                    $('status').innerText = 'Text response received (see debug log). Model might not have generated an image.';
                } else {
                    $('status').innerText = 'Image generated successfully!';
                }

            } catch (e) {
                $('status').innerText = 'Error: ' + e.message;
                console.error(e);
            } finally {
                $('testBtn').disabled = false;
            }
        }
    </script>
</body>

</html>